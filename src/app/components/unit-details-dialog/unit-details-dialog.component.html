<base-dialog (closed)="onClose()">
    <div dialog-header class="header"> 
        <div class="header-group">
            <div class="header-era">
                <img src="{{ getUnitImg(unit) }}" class="icon" alt="{{ unit.model }} {{ unit.chassis }}" />
            </div>
            <div class="header-name-group">
                <div class="header-model allow-select">{{ unit.model }}</div>
                <div class="header-chassis allow-select">{{ unit.chassis }}</div>
            </div>
        </div>
        <div class="spanner"></div>
        <div class="header-details-container">
            <div class="spanner"></div>
            <div class="header-details">
                <div class="role" *ngIf="unit.role && unit.role != 'None'"><strong>{{ unit.role }}</strong></div>
                <div class="info-slot numeric allow-select" title="Tonnage">
                    <span class="value">{{ formatThousands(unit.tons) }}</span>
                    <img src="/images/weight.svg" class="icon" alt="tons">
                </div>
            </div>
        </div>
    </div>
    <div dialog-body class="dialog-body">
        <button
            *ngIf="hasPrev"
            class="nav-arrow nav-arrow-left"
            (click)="onPrev()"
            aria-label="Previous Unit">
            &#10094;
        </button>
        <button
            *ngIf="hasNext"
            class="nav-arrow nav-arrow-right"
            (click)="onNext()"
            aria-label="Next Unit">
            &#10095;
        </button>
        <!-- Basic Info -->
        <div class="basic-info-block allow-select">
            <div><strong>{{ unit.type }}<span *ngIf="unit.subtype != unit.type"> - {{ unit.subtype }}</span> - {{ unit.weightClass }}</strong></div>
            <div><span class="muted">BV: </span><strong>{{ formatThousands(unit.bv) }}</strong></div>
            <div><span class="muted">Tech: </span><strong>{{ unit.techBase }} | {{ unit.techRating }}</strong></div>
            <div *ngIf="unit.year"><span class="muted">Intro Year: </span><strong>{{ unit.year }}</strong> <img src="{{ getEraImg(unit) }}" class="era-icon" title="{{ unit._era?.name }}" /></div>
            <div *ngIf="unit.armorType"><span class="muted">Armor Type: </span><strong>{{ unit.armorType }}</strong></div>
            <div *ngIf="unit.moveType"><span class="muted">Motive Type: </span><strong>{{ unit.moveType }}</strong></div>
            <div *ngIf="unit.engine"><span class="muted">Engine: </span><strong><span *ngIf="unit.engineRating">{{ unit.engineRating }} </span>{{ unit.engine }}</strong></div>
            <div *ngIf="unit.c3 && unit.c3 != 'None'"><span class="muted">Network: </span><strong>{{ unit.c3 }}</strong></div>
            <div><span class="muted">C-Bill Cost: </span><strong>{{ formatThousands(unit.cost) }}</strong></div>
        </div>
        <div class="quirks-block" *ngIf="unit.quirks && unit.quirks.length > 0">
            <div class="quirks">
                <div class="muted">Quirks:</div>
                <div *ngFor="let quirk of unit.quirks">
                    <div class="quirk"
                        [ngClass]="getQuirkClass(quirk)"
                        [title]="getQuirkDesc(quirk)">{{ quirk }}</div>
                </div>
            </div>
        </div>
        <!-- Stat Progress Bars -->
        <div class="stat-bars-columns">
            <div class="stat-bar-row" *ngFor="let spec of statBarSpecs">
                <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getStatPercent(spec.value, spec.max)"></div>
                </div>
                <span class="stat-label">{{ spec.label }}</span>
                <span class="stat-value">{{ spec.value }}</span>
            </div>
        </div>

        <!-- Weapon Type Summary Bar -->
        <div class="type-summary-bar">
            <!-- First block: first 3 weapon types -->
            <div class="type-summary-block">
                <ng-container *ngFor="let type of weaponTypes.slice(0, 3)">
                    <div class="type-summary-rect" [ngStyle]="{'border-color': type.color}" [title]="type.name">
                        <div [ngStyle]="{'background-color': type.color}" class="icon">
                            <img class="type-icon" [src]="getTypeIcon(type.code)" />
                        </div>
                        <div class="type-count">{{ getTypeCount(type.code) }}</div>
                    </div>
                </ng-container>
            </div>
            <!-- Second block: last 3 weapon types -->
            <div class="type-summary-block">
                <ng-container *ngFor="let type of weaponTypes.slice(3)" class="type-summary-block">
                    <div class="type-summary-rect" [ngStyle]="{'border-color': type.color}" [title]="type.name">
                        <div [ngStyle]="{'background-color': type.color}" class="icon">
                            <img class="type-icon" [src]="getTypeIcon(type.code)" />
                        </div>
                        <div class="type-count">{{ getTypeCount(type.code) }}</div>
                    </div>
                </ng-container>
            </div>
        </div>

        <!-- Components Grid -->
        <!-- Matrix layout (3x3) when supported and defined for unit.type -->
        <ng-container *ngIf="useMatrixLayout; else defaultComponentsBlock">
            <div class="components-matrix" [style.grid-template-areas]="gridAreas">
                <div
                    *ngFor="let area of matrixAreaCodes"
                    class="component-rect"
                    [style.grid-area]="area">
                    <div class="comp-loc" *ngIf="areaHasContent(area)">{{ getAreaLabel(area) }}</div>
                    <div class="comp-list">
                        <!-- Bays (matrix) -->
                        <ng-container *ngIf="areaHasBays(area); else matrixNormalComponents">
                            <div class="bay">
                                <div *ngFor="let bay of getBaysForArea(area); trackBy: trackByBay"
                                    class="subcomponent-data {{ getTypeClass(bay.t) }}"
                                    (mouseenter)="onCompMouseEnter(bay, $event)"
                                    (mouseleave)="onCompMouseLeave()">
                                    <div class="comp-title">
                                        <span class="comp-qty">{{ bay.q }}×</span>
                                        <span class="comp-name">{{ bay.n }}</span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Normal components (matrix) -->
                        <ng-template #matrixNormalComponents>
                            <div *ngFor="let comp of getComponentsForArea(area); trackBy: trackByComp"
                                class="component-data {{ getTypeClass(comp.t) }}"
                                (mouseenter)="onCompMouseEnter(comp, $event)"
                                (mouseleave)="onCompMouseLeave()">
                                <div class="comp-title">
                                    <span class="comp-qty">{{ comp.q }}×</span>
                                    <span class="comp-name">{{ comp.n }}</span>
                                </div>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>
        </ng-container>

        <!-- Default -->
        <ng-template #defaultComponentsBlock>
            <div class="components-container" *ngIf="hasBays(); else normalComponents">
                <div *ngFor="let group of groupedBays; trackBy: trackByBayLoc" class="component-rect">
                    <div class="comp-loc">{{ group.l }}</div>
                    <div class="bay">
                        <div *ngFor="let bay of group.bays" class="subcomponent-data {{ getTypeClass(bay.t) }}"
                            (mouseenter)="onCompMouseEnter(bay, $event)"
                            (mouseleave)="onCompMouseLeave()">
                            <div class="comp-title">
                                <span class="comp-qty">{{ bay.q }}×</span>
                                <span class="comp-name">{{ bay.n }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <ng-template #normalComponents>
                <div class="components-container">
                    <div *ngFor="let comp of components" class="component-rect">
                        <div class="comp-loc">{{ comp.l }}</div>
                        <div class="component-data {{ getTypeClass(comp.t) }}"
                        (mouseenter)="onCompMouseEnter(comp, $event)"
                        (mouseleave)="onCompMouseLeave()">
                            <div class="comp-title">
                                <span class="comp-qty">{{ comp.q }}×</span>
                                <span class="comp-name">{{ comp.n }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
        </ng-template>

        <div class="spanner"></div>

        <div class="bottom-info">
            <div class="bottom-left" *ngIf="unit.source"><span class="muted">Source: </span><strong>{{ unit.source }}</strong></div>
            <div class="bottom-right" *ngIf="unit.id && unit.id > 0"><span class="muted">MUL ID: </span><a class="mul-link" target=_BLANK href="http://masterunitlist.info/Unit/Details/{{unit.id}}">{{ unit.id }}</a></div>
        </div>
    </div>
    <div class="footer" dialog-footer>
        <button *ngIf="!hideAddButton" class="modal-btn bt-button" (click)="onAdd()">ADD</button>
        <button class="modal-btn bt-button" (click)="onShare()">SHARE</button>    
        <button class="modal-btn bt-button" (click)="onClose()">CLOSE</button>
    </div>
</base-dialog>
 <floating-comp-info
    [unit]="unit"
    [comp]="hoveredComp()"
    [hoverRect]="hoverRect()"
    (mouseenter)="onFloatingMouseEnter()"
    (mouseleave)="onFloatingMouseLeave()">
</floating-comp-info>