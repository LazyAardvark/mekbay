name: CD/CI Release
run-name: Deploy MekBay to mekbay.com
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    name: Build and Upload
    runs-on: ubuntu-latest
    steps:
      - name: Get latest code
        uses: actions/checkout@v2.3.2
      - name: Use Node.js 20
        uses: actions/setup-node@v2
        with:
          node-version: '20'
      - name: Install NPM and Build Angular Project
        run: |  
          npm install
          npm run build
      - name: Get LFTP
        run: sudo apt-get install -y --no-install-recommends lftp
      - name: Configure LFTP
        run: mkdir ~/.lftp && echo "set ssl:verify-certificate false;" >> ~/.lftp/rc
      - name: Load Secrets
        run: echo "machine ${{ secrets.FTP_HOST }} login ${{ secrets.FTP_USER }} password ${{ secrets.FTP_PASSWORD }}" > ~/.netrc
      - name: Upload Folder (with cleanup)  
        run: |
          lftp -c "set ftp:list-options -a; 
          open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }};
          mirror --parallel=100 -R --delete --transfer-all --no-perms --verbose ./dist/browser/ ./mekbay/"
